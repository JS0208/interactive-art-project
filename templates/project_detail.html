{% extends "base.html" %}

{% block title %}{{ project.name }} - Interactive Art{% endblock %}

{% block content %}
<a href="/projects" class="text-blue-500 hover:underline mb-6 inline-block text-lg">&larr; Back to Projects</a>
<h1 class="text-4xl font-bold mb-4 text-[var(--color-text-primary)]">{{ project.name }}</h1>
<p class="text-lg text-[var(--color-text-primary)] mb-8">{{ project.description }}</p>

<div class="card p-6 mb-8">
    <div class="relative flex justify-center items-center bg-gray-900 rounded-lg overflow-hidden shadow-inner" style="max-width: 100%; height: auto;">
        <canvas id="gameCanvas" class="border-2 border-gray-700 focus:outline-none" tabindex="0"></canvas>
        
        <div id="gameOverOverlay" class="absolute inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center text-white text-center hidden">
            <h2 class="text-5xl font-bold mb-4" id="gameOverTitle">Game Over!</h2>
            <p class="text-2xl mb-6" id="gameOverScore"></p>
            <button id="restartGameBtn" class="btn-primary text-xl py-3 px-6">Restart Game<br><span class="text-sm">(r) to restart</span><br><span class="text-sm">(t) to randomize and restart</span></button>
        </div>
    </div>
    <div class="text-center mt-6">
        <button id="start-game-btn" class="btn-primary text-lg py-3 px-6">Start Game</button>
        <div id="game-info" class="mt-4 text-[var(--color-text-primary)] text-lg font-medium"></div>
        
        <div id="game-settings" class="mt-5 p-4 rounded-lg shadow-inner text-left">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-[var(--color-text-primary)]">Game Settings:</h3>
                <div class="space-x-2">
                    <button id="resetParamsBtn" class="btn-secondary px-4 py-2 text-sm font-semibold">Reset</button>
                    <button id="randomizeParamsBtn" class="btn-primary px-4 py-2 text-sm font-semibold">Randomize</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4">
                {% if project_id == 'brick_breaker' %}
                <div class="p-4 border rounded-md">
                    <h4 class="text-lg font-semibold mb-2 text-[var(--color-text-primary)]">Ball & Paddle</h4>
                    <label class="block text-sm font-medium text-[var(--color-text-primary)]">Ball Speed: <span id="ballSpeedValue">2</span></label>
                    <input type="range" id="ballSpeed" min="1" max="10" value="2" class="w-full slider">
                    
                    <label class="block text-sm font-medium text-[var(--color-text-primary)] mt-2">Ball Radius: <span id="ballRadiusValue">10</span></label>
                    <input type="range" id="ballRadius" min="5" max="15" value="10" class="w-full slider">

                    <label class="block text-sm font-medium text-[var(--color-text-primary)] mt-2">Paddle Width: <span id="paddleWidthValue">75</span></label>
                    <input type="range" id="paddleWidth" min="50" max="150" value="75" step="5" class="w-full slider">
                    
                    <label class="block text-sm font-medium text-[var(--color-text-primary)] mt-2">Paddle Speed: <span id="paddleSpeedValue">7</span></label>
                    <input type="range" id="paddleSpeed" min="3" max="15" value="7" class="w-full slider">

                    <label class="block text-sm font-medium text-[var(--color-text-primary)] mt-2">Ball Acceleration: <span id="ballAccelerationValue">0.05</span></label>
                    <input type="range" id="ballAcceleration" min="0" max="0.2" value="0.05" step="0.01" class="w-full slider">
                </div>
                
                <div class="p-4 border rounded-md">
                    <h4 class="text-lg font-semibold mb-2 text-[var(--color-text-primary)]">Bricks</h4>
                    <label class="block text-sm font-medium text-[var(--color-text-primary)]">Rows: <span id="brickRowsValue">3</span></label>
                    <input type="range" id="brickRows" min="1" max="10" value="3" class="w-full slider">
                    
                    <label class="block text-sm font-medium text-[var(--color-text-primary)] mt-2">Columns: <span id="brickColsValue">5</span></label>
                    <input type="range" id="brickCols" min="3" max="10" value="5" class="w-full slider">

                    <label class="block text-sm font-medium text-[var(--color-text-primary)] mt-2">Brick Width: <span id="brickWidthValue">75</span></label>
                    <input type="range" id="brickWidth" min="50" max="100" value="75" step="5" class="w-full slider">

                    <label class="block text-sm font-medium text-[var(--color-text-primary)] mt-2">Brick Height: <span id="brickHeightValue">20</span></label>
                    <input type="range" id="brickHeight" min="10" max="30" value="20" step="2" class="w-full slider">
                </div>

                <div class="p-4 border rounded-md">
                    <h4 class="text-lg font-semibold mb-2 text-[var(--color-text-primary)]">Game Rules & Effects</h4>
                    <label class="block text-sm font-medium text-[var(--color-text-primary)]">Lives: <span id="livesValue">3</span></label>
                    <input type="range" id="lives" min="1" max="10" value="3" class="w-full slider">

                    <label class="block text-sm font-medium text-[var(--color-text-primary)] mt-2">Particle Size: <span id="particleSizeValue">10</span></label>
                    <input type="range" id="particleSize" min="2" max="20" value="10" class="w-full slider">

                    <label class="block text-sm font-medium text-[var(--color-text-primary)] mt-2">Particle Lifespan: <span id="particleLifespanValue">0.02</span></label>
                    <input type="range" id="particleLifespan" min="0.01" max="0.05" value="0.02" step="0.005" class="w-full slider">

                    <div class="flex justify-between items-center mt-3">
                        <label for="ballColor" class="text-sm font-medium text-[var(--color-text-primary)]">Ball Color</label>
                        <input type="color" id="ballColor" value="#E0E0E0" class="p-1 h-8 w-14 block bg-white border border-gray-200 cursor-pointer rounded-lg disabled:opacity-50 disabled:pointer-events-none dark:bg-slate-900 dark:border-gray-700">
                    </div>
                     <div class="flex justify-between items-center mt-2">
                        <label for="paddleColor" class="text-sm font-medium text-[var(--color-text-primary)]">Paddle Color</label>
                        <input type="color" id="paddleColor" value="#E0E0E0" class="p-1 h-8 w-14 block bg-white border border-gray-200 cursor-pointer rounded-lg disabled:opacity-50 disabled:pointer-events-none dark:bg-slate-900 dark:border-gray-700">
                    </div>
                </div>

                {% elif project_id == 'snake_game' %}
                <div class="p-4 border rounded-md">
                    <h4 class="text-lg font-semibold mb-2 text-[var(--color-text-primary)]">Gameplay</h4>
                    <label class="block text-sm font-medium text-[var(--color-text-primary)]">Speed (delay ms): <span id="snakeSpeedValue">100</span></label>
                    <input type="range" id="snakeSpeed" min="30" max="200" value="100" step="10" class="w-full slider">
                    
                    <label class="block text-sm font-medium text-[var(--color-text-primary)] mt-2">Grid Size (px): <span id="gridSizeValue">20</span></label>
                    <input type="range" id="gridSize" min="10" max="40" value="20" step="2" class="w-full slider">
                    
                    <label class="block text-sm font-medium text-[var(--color-text-primary)] mt-2">Initial Length: <span id="initialLengthValue">3</span></label>
                    <input type="range" id="initialLength" min="1" max="10" value="3" class="w-full slider">

                    <label class="block text-sm font-medium text-[var(--color-text-primary)] mt-2">Growth Factor: <span id="growthFactorValue">1</span></label>
                    <input type="range" id="growthFactor" min="1" max="5" value="1" class="w-full slider">
                </div>

                <div class="p-4 border rounded-md">
                    <h4 class="text-lg font-semibold mb-2 text-[var(--color-text-primary)]">Rules</h4>
                     <label for="wallBehavior" class="block text-sm font-medium text-[var(--color-text-primary)]">Wall Behavior</label>
                    <select id="wallBehavior" class="w-full p-2 mt-1 rounded-md bg-gray-200 dark:bg-gray-700 text-[var(--color-text-primary)]">
                        <option value="gameOver">Game Over</option>
                        <option value="wrapAround">Wrap Around</option>
                    </select>

                    <div class="flex items-center mt-4">
                        <input type="checkbox" id="selfCollision" checked class="h-4 w-4 rounded">
                        <label for="selfCollision" class="ml-2 text-sm font-medium text-[var(--color-text-primary)]">Game Over on Self-Collision</label>
                    </div>
                    <div class="flex items-center mt-3">
                        <input type="checkbox" id="gridVisible" class="h-4 w-4 rounded">
                        <label for="gridVisible" class="ml-2 text-sm font-medium text-[var(--color-text-primary)]">Show Grid</label>
                    </div>
                </div>

                <div class="p-4 border rounded-md">
                    <h4 class="text-lg font-semibold mb-2 text-[var(--color-text-primary)]">Appearance</h4>
                     <label for="snakeColorMode" class="block text-sm font-medium text-[var(--color-text-primary)]">Snake Color Mode</label>
                    <select id="snakeColorMode" class="w-full p-2 mt-1 rounded-md bg-gray-200 dark:bg-gray-700 text-[var(--color-text-primary)]">
                        <option value="rainbow">Rainbow</option>
                        <option value="solid">Solid</option>
                        <option value="gradient">Gradient</option>
                    </select>
                    <div id="snakeColorPickers" class="mt-2 space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="snakeHeadColor" class="text-sm font-medium text-[var(--color-text-primary)]">Head Color</label>
                            <input type="color" id="snakeHeadColor" value="#FFFFFF" class="color-picker">
                        </div>
                        <div class="flex justify-between items-center">
                            <label for="snakeTailColor" class="text-sm font-medium text-[var(--color-text-primary)]">Tail Color</label>
                            <input type="color" id="snakeTailColor" value="#808080" class="color-picker">
                        </div>
                    </div>
                </div>
                {% else %}
                <p class="text-sm text-[var(--color-text-primary)]">No specific settings for this art piece.</p>
                {% endif %}
            </div>
        </div>

        <div id="game-controls" class="mt-5 p-4 rounded-lg shadow-inner">
            <h3 class="text-xl font-semibold mb-3 text-[var(--color-text-primary)]">Controls:</h3>
            <ul class="list-disc list-inside text-left mx-auto max-w-md text-[var(--color-text-primary)]">
                <li><b>ESC Key:</b> End game immediately</li>
                {% if project_id == 'brick_breaker' %}
                <li>Left/Right Arrow Keys or Touch: Move Paddle</li>
                {% elif project_id == 'snake_game' %}
                <li>Arrow Keys or Swipe: Change Snake Direction</li>
                {% else %}
                <li>No specific controls for this art piece.</li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>

<style>
    .slider {
        -webkit-appearance: none;
        width: 100%;
        height: 8px;
        border-radius: 5px;
        background: #ddd;
        outline: none;
        opacity: 0.9;
        transition: opacity .2s;
    }
    .dark .slider { background: #4a5568; }
    .slider:hover { opacity: 1; }
    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--color-primary);
        cursor: pointer;
    }
    .color-picker {
        padding: 2px;
        height: 2rem;
        width: 3.5rem;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 0.375rem;
        cursor: pointer;
    }
    .dark .color-picker { background-color: #1a202c; border-color: #4a5568; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const startGameBtn = document.getElementById('start-game-btn');
    const restartGameBtn = document.getElementById('restartGameBtn');
    const gameInfo = document.getElementById('game-info');
    const gameOverOverlay = document.getElementById('gameOverOverlay');
    const gameOverTitle = document.getElementById('gameOverTitle');
    const gameOverScore = document.getElementById('gameOverScore');
    const resetParamsBtn = document.getElementById('resetParamsBtn');
    const randomizeParamsBtn = document.getElementById('randomizeParamsBtn');
    const projectId = "{{ project_id }}";
    let gameModule = null;
    let isGameRunning = false;

    function setCanvasSize() {
        const parentDiv = canvas.parentElement;
        const aspectRatio = 600 / 400; 
        let newWidth = parentDiv.clientWidth > 800 ? 800 : parentDiv.clientWidth;
        canvas.width = newWidth;
        canvas.height = newWidth / aspectRatio;
    }
    setCanvasSize();
    window.addEventListener('resize', setCanvasSize);

    // --- 파라미터 설정 ---
    const paramsConfig = {
        brick_breaker: {
            ballSpeed: { el: 'ballSpeed', type: 'range', default: 2, min: 1, max: 10 },
            ballRadius: { el: 'ballRadius', type: 'range', default: 10, min: 5, max: 15 },
            paddleWidth: { el: 'paddleWidth', type: 'range', default: 75, min: 50, max: 150, step: 5 },
            paddleSpeed: { el: 'paddleSpeed', type: 'range', default: 7, min: 3, max: 15 },
            ballAcceleration: { el: 'ballAcceleration', type: 'range', default: 0.05, min: 0, max: 0.2, step: 0.01 },
            brickRows: { el: 'brickRows', type: 'range', default: 3, min: 1, max: 10 },
            brickCols: { el: 'brickCols', type: 'range', default: 5, min: 3, max: 10 },
            brickWidth: { el: 'brickWidth', type: 'range', default: 75, min: 50, max: 100, step: 5 },
            brickHeight: { el: 'brickHeight', type: 'range', default: 20, min: 10, max: 30, step: 2 },
            lives: { el: 'lives', type: 'range', default: 3, min: 1, max: 10 },
            particleSize: { el: 'particleSize', type: 'range', default: 10, min: 2, max: 20 },
            particleLifespan: { el: 'particleLifespan', type: 'range', default: 0.02, min: 0.01, max: 0.05, step: 0.005 },
            ballColor: { el: 'ballColor', type: 'color', default: '#E0E0E0' },
            paddleColor: { el: 'paddleColor', type: 'color', default: '#E0E0E0' },
        },
        snake_game: {
            snakeSpeed: { el: 'snakeSpeed', type: 'range', default: 100, min: 30, max: 200, step: 10 },
            gridSize: { el: 'gridSize', type: 'range', default: 20, min: 10, max: 40, step: 2 },
            initialLength: { el: 'initialLength', type: 'range', default: 3, min: 1, max: 10 },
            growthFactor: { el: 'growthFactor', type: 'range', default: 1, min: 1, max: 5 },
            wallBehavior: { el: 'wallBehavior', type: 'select', default: 'gameOver' },
            selfCollision: { el: 'selfCollision', type: 'checkbox', default: true },
            gridVisible: { el: 'gridVisible', type: 'checkbox', default: false },
            snakeColorMode: { el: 'snakeColorMode', type: 'select', default: 'rainbow' },
            snakeHeadColor: { el: 'snakeHeadColor', type: 'color', default: '#FFFFFF' },
            snakeTailColor: { el: 'snakeTailColor', type: 'color', default: '#808080' },
        }
    };
    
    const currentParams = paramsConfig[projectId];

    function setupEventListeners() {
        if (!currentParams) return;
        for (const key in currentParams) {
            const param = currentParams[key];
            param.element = document.getElementById(param.el);
            if(param.element) {
                param.element.addEventListener('input', () => updateValue(key));
                if (param.type === 'range') {
                    param.valueSpan = document.getElementById(`${param.el}Value`);
                }
            }
        }
        if (projectId === 'snake_game') {
            const colorModeSelect = document.getElementById('snakeColorMode');
            if (colorModeSelect) {
                colorModeSelect.addEventListener('change', toggleSnakeColorPickers);
                toggleSnakeColorPickers();
            }
        }
    }

    function toggleSnakeColorPickers() {
        const mode = document.getElementById('snakeColorMode').value;
        const pickersDiv = document.getElementById('snakeColorPickers');
        if (!pickersDiv) return;
        
        const headPicker = document.getElementById('snakeHeadColor').parentElement;
        const tailPicker = document.getElementById('snakeTailColor').parentElement;

        if (mode === 'solid') {
            pickersDiv.style.display = 'block';
            headPicker.style.display = 'flex';
            tailPicker.style.display = 'none';
        } else if (mode === 'gradient') {
            pickersDiv.style.display = 'block';
            headPicker.style.display = 'flex';
            tailPicker.style.display = 'flex';
        } else { // rainbow
            pickersDiv.style.display = 'none';
        }
    }

    function updateValue(key, value) {
        const param = currentParams[key];
        if (!param || !param.element) return;
        const displayValue = value !== undefined ? value : param.element.value;
        if (param.type === 'range' && param.valueSpan) {
            param.valueSpan.textContent = displayValue;
        }
    }

    function toggleParameterInputs(disabled) {
        if (currentParams) {
            for (const key in currentParams) {
                if (currentParams[key] && currentParams[key].element) {
                    currentParams[key].element.disabled = disabled;
                }
            }
        }
        if (resetParamsBtn) resetParamsBtn.disabled = disabled;
        if (randomizeParamsBtn) randomizeParamsBtn.disabled = disabled;
    }

    function resetParameters() {
        if (!currentParams) return;
        for (const key in currentParams) {
            const param = currentParams[key];
            if (param && param.element) {
                if (param.type === 'checkbox') {
                    param.element.checked = param.default;
                } else {
                    param.element.value = param.default;
                }
                updateValue(key, param.default);
            }
        }
        if (projectId === 'snake_game') toggleSnakeColorPickers();
    }

    function randomizeParameters() {
        if (!currentParams) return;
        for (const key in currentParams) {
            const param = currentParams[key];
            if (param && param.element) {
                if (param.type === 'range') {
                    const step = parseFloat(param.element.step) || 1;
                    const min = parseFloat(param.element.min);
                    const max = parseFloat(param.element.max);
                    const numSteps = (max - min) / step;
                    const randomStep = Math.round(Math.random() * numSteps);
                    let randomValue = min + randomStep * step;
                    if (step < 1) randomValue = parseFloat(randomValue.toFixed(2));
                    param.element.value = randomValue;
                    updateValue(key, randomValue);
                } else if (param.type === 'checkbox') {
                    param.element.checked = Math.random() < 0.5;
                } else if (param.type === 'select') {
                    const options = param.element.options;
                    param.element.selectedIndex = Math.floor(Math.random() * options.length);
                } else if (param.type === 'color') {
                    param.element.value = `#${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}`;
                }
            }
        }
        if (projectId === 'snake_game') toggleSnakeColorPickers();
    }

    resetParamsBtn.addEventListener('click', resetParameters);
    randomizeParamsBtn.addEventListener('click', randomizeParameters);

    window.hideGameOver = function() { gameOverOverlay.classList.add('hidden'); };
    window.showGameOver = function(title, score) {
        isGameRunning = false;
        gameOverTitle.textContent = title;
        gameOverScore.textContent = score;
        gameOverOverlay.classList.remove('hidden');
        startGameBtn.disabled = false;
        document.body.classList.remove('overflow-hidden');
        toggleParameterInputs(false);
    };

    function getGameSettings() {
        const settings = {};
        if (currentParams) {
            for (const key in currentParams) {
                const param = currentParams[key];
                if (param && param.element) {
                    const el = param.element;
                    if (el.type === 'checkbox') {
                        settings[key] = el.checked;
                    } else if (el.type === 'range' || el.type === 'number') {
                        settings[key] = parseFloat(el.value);
                    } else {
                        settings[key] = el.value;
                    }
                }
            }
        }
        return settings;
    }

    function handleStartGame() {
        hideGameOver();
        if (gameModule && typeof gameModule.startGame === 'function') {
            isGameRunning = true;
            toggleParameterInputs(true);
            gameModule.startGame(getGameSettings());
            startGameBtn.disabled = true;
            canvas.focus();
            document.body.classList.add('overflow-hidden');
        } else {
            console.error("Game not ready or start function missing.");
        }
    }

    startGameBtn.addEventListener('click', handleStartGame);
    restartGameBtn.addEventListener('click', handleStartGame);

    document.addEventListener('keydown', (e) => {
        if (e.target.tagName.toLowerCase() === 'input') return;
        
        // --- ✨ ESC 키로 즉시 게임오버 기능 추가 ✨ ---
        if (e.key === 'Escape' && isGameRunning) {
            e.preventDefault();
            if (gameModule && typeof gameModule.stopGame === 'function') {
                gameModule.stopGame();
            }
            window.showGameOver('Game Ended', 'You ended the game.');
        }

        if (e.key.toLowerCase() === 'r') {
            e.preventDefault();
            if (gameModule && typeof gameModule.stopGame === 'function') gameModule.stopGame();
            handleStartGame();
        }
        if (e.key.toLowerCase() === 't') {
            e.preventDefault();
            if (!randomizeParamsBtn.disabled) randomizeParameters();
            if (gameModule && typeof gameModule.stopGame === 'function') gameModule.stopGame();
            handleStartGame();
        }
    });

    canvas.addEventListener('keydown', (e) => {
        if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(e.key)) {
            e.preventDefault();
        }
    });
    
    // --- 초기화 ---
    const script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = `/static/${projectId}.js`;
    script.onload = () => {
        const gameFunctionName = `${projectId}Game`;
        if (typeof window[gameFunctionName] === 'function') {
            gameModule = window[gameFunctionName](canvas, ctx, gameInfo, window);
            gameInfo.textContent = `Ready to play ${projectId.replace(/_/g, ' ')}!`;
            setupEventListeners();
            resetParameters();
        } else {
            gameInfo.textContent = `Error: Game module for ${projectId} not found.`;
        }
    };
    script.onerror = () => { gameInfo.textContent = `Error loading game script for ${projectId}.`; };
    document.body.appendChild(script);
});
</script>
{% endblock %}
